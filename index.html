<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voice Interface</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            padding: 20px;
        }
        #status { font-size: 2rem; margin-bottom: 20px; font-weight: bold; }
        #instruction { font-size: 1.2rem; color: #aaa; }
        .error { color: #ff4444 !important; }
        .active { color: #00ff00 !important; }
    </style>
</head>
<body>

    <div id="status">System Initializing...</div>
    <div id="instruction">Please wait...</div>

    <script>
        // --- CONFIGURATION ---
        const synth = window.speechSynthesis;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        let recognition;
        let isSystemSpeaking = false;

        // --- 1. SAFE SPEAKING FUNCTION ---
        // This handles the "Talking" part.
        function speak(text) {
            if (synth.speaking) return;

            isSystemSpeaking = true;
            
            // If we have a recognizer, pause it so we don't hear ourselves
            if (recognition) recognition.stop();

            const utterance = new SpeechSynthesisUtterance(text);
            
            utterance.onend = () => {
                isSystemSpeaking = false;
                // Only restart listening if the browser actually supports it
                if (recognition) { 
                    try { recognition.start(); } catch(e){} 
                }
            };

            synth.speak(utterance);
        }

        // --- 2. BROWSER CHECK & SETUP ---
        function initSystem() {
            if (!SpeechRecognition) {
                handleError("unsupported");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            // --- COMMAND HANDLING ---
            recognition.onresult = (event) => {
                const command = event.results[0][0].transcript.toLowerCase();
                document.getElementById('instruction').innerText = `Heard: "${command}"`;

                if (command.includes('hello')) {
                    speak("Hello. I am functioning perfectly.");
                } else if (command.includes('time')) {
                    speak("The time is " + new Date().toLocaleTimeString());
                } else if (command.includes('stop')) {
                    speak("Goodbye.");
                } else {
                    speak("I heard " + command + ". Say time or hello.");
                }
            };

            // --- ERROR HANDLING (BRAVE FIX) ---
            recognition.onerror = (event) => {
                console.log("Error:", event.error);

                // "Network" error usually means Brave is blocking Google Servers
                if (event.error === 'network') {
                    handleError("brave-block");
                } 
                else if (event.error === 'not-allowed') {
                    handleError("mic-blocked");
                }
            };

            // Keep the mic alive if it turns off
            recognition.onend = () => {
                if (!isSystemSpeaking) {
                    try { recognition.start(); } catch(e){}
                }
            };

            // Start everything
            speak("System online. Waiting for command.");
        }

        // --- 3. ERROR MANAGER ---
        function handleError(type) {
            const statusEl = document.getElementById('status');
            const instructEl = document.getElementById('instruction');
            
            if (type === "brave-block") {
                statusEl.innerText = "BROWSER ERROR";
                statusEl.className = "error";
                instructEl.innerText = "This browser (Brave/Firefox) blocks voice features.";
                // CRITICAL: Verbally tell the user what is wrong
                speak("Error. This browser is blocking my connection. Please open this site in Google Chrome.");
            }
            else if (type === "mic-blocked") {
                statusEl.innerText = "MIC BLOCKED";
                statusEl.className = "error";
                speak("I cannot hear you. Please allow microphone access in your settings.");
            }
            else if (type === "unsupported") {
                statusEl.innerText = "NOT SUPPORTED";
                speak("Your browser does not support voice control. Please use Google Chrome.");
            }
        }

        // --- 4. AUTO-START ---
        window.onload = function() {
            setTimeout(initSystem, 1000);
        };

    </script>
</body>
</html>
